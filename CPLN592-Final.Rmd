---
title: "Forecasting parking demand"
author: "Yanbing Zhao, Chenxi Zhu"
date: "December 16, 2022"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r load_packages, warning = FALSE}
options(scipen=10000000)

library(tidyverse)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(tidycensus)
library(broom)
library(RSocrata)
library(sf)
library(riem)
library(gridExtra)
library(viridis)
library(spatstat)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(classInt)
# library(patchwork)
library(ggplot2)
library(gganimate)
library(hms)
library(gifski)
library(stargazer)

# data directory
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
# subsidy <- read.csv(file.path(root.dir,"/Chapter6/housingSubsidy.csv"))

palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")
```

Read meter and transaction data.

```{r read_data, warning=FALSE, message=FALSE}
epsg <- 'EPSG:6419'
district <- st_read("data/Planning Districts.geojson") %>% filter(district == "Downtown") %>%
  st_transform(epsg)

# collect downtown meters and transactions only
meter <- read.csv("data/Parking_Meters.csv") %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(epsg)# %>%
  # st_join(., district) %>%
  # filter(!is.na(district))

street <- st_read("data/Speed Limits per Street Segment.geojson") %>%
  st_transform(epsg) %>%
  st_join(., district) %>%
  filter(!is.na(district))

# time_frame <- 
transaction <- read.socrata("https://data.sfgov.org/resource/imvp-dq3v.json?$where=session_start_dt between '2022-01-03T12:00:00' and '2022-01-23T12:00:00'")
transaction <- transaction[transaction$post_id %in% meter$POST_ID, ]

# index table to connect block - street id - post id
idx <- read.csv("data/index_table.csv")
```

Visualize spatial distribution of meters in downtown.

```{r visualize_downtown_meters, warning=FALSE, message=FALSE}
ggplot() + 
  geom_sf(data = district) +
  # geom_sf(data = street) +
  geom_sf(data = meter%>%st_join(., district) %>% filter(!is.na(district)), colour="blue", size = 0.1, show.legend = "point") +
  labs(title= "Parking Meters in Downtown") +
  mapTheme(title_size = 14)
```

### Dependent Variable

```{r for_complete_panel_creation, warning=FALSE, message=FALSE, include=FLASE}
weather.panel <- 
  riem_measures(station = "SFO", date_start = "2022-01-03", date_end = "2022-01-23") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))
```

average occupancy rate by street segment aggregated by meter

```{r panel_setup, warning=FALSE, message=FALSE}
occ.panel =
  expand.grid(interval60 = unique(weather.panel$interval60), 
              POST_ID = unique(transaction$post_id))%>%
  mutate(parking_time_in_60m = 0,
         index = row_number())
```

```{r calculate_occupancy, warning=FALSE, message=FALSE}
dat2 <- transaction %>%
  # filter(post_id == "923-00001") %>%
  mutate(end_interval = floor_date(ymd_hms(session_end_dt), unit = "1 hour"),
         start_interval = floor_date(ymd_hms(session_start_dt), unit = "1 hour"),
         length = end_interval - start_interval,
         tokens = as.numeric(length )/ 900*4,
         tokens_00 = ifelse(tokens >= 1, 1, 0),
         tokens_01 = ifelse(tokens >= 2, 1, 0),
         tokens_02 = ifelse(tokens >=   3, 1, 0),
         # tokens_03 = ifelse(tokens >= 4, 1, 0),
         # tokens_04 = ifelse(tokens >= 5, 1, 0),
         # tokens_05 = ifelse(tokens >= 6, 1, 0),
         # tokens_06 = ifelse(tokens >= 7, 1, 0),
         # tokens_07 = ifelse(tokens >= 8, 1, 0),
         # tokens_08 = ifelse(tokens >= 9, 1, 0),
         # tokens_09 = ifelse(tokens >= 10, 1, 0),
         # tokens_10 = ifelse(tokens >= 11, 1, 0),
         # tokens_11 = ifelse(tokens >= 12, 1, 0)
         )

dat3 <- dat2 %>%
  group_by(start_interval, post_id) %>%
  summarize(tokens_00 = sum(tokens_00),
            tokens_01 = sum(tokens_01),
            tokens_02 = sum(tokens_02),
            # tokens_03 = sum(tokens_03),
            # tokens_04 = sum(tokens_04),
            # tokens_05 = sum(tokens_05),
            # tokens_06 = sum(tokens_06),
            # tokens_07 = sum(tokens_07),
            # tokens_08 = sum(tokens_08),
            # tokens_09 = sum(tokens_09),
            # tokens_10 = sum(tokens_10),
            # tokens_11 = sum(tokens_11)
            )

# Create a panel consisting of all the time/meter observations in the set
# Add a day of the year to each observation, join it to the transaction data
# This might need to be tinkered with to make sure every time period for every meter is included
# There are some weird one-off transactions off hours that might need to be cleaned out

study.panel <- 
  expand.grid(start_interval=unique(dat3$start_interval), 
              post_id = unique(dat3$post_id)) %>%
  mutate(doty = yday(start_interval)) %>%
  left_join(., dat3)

# Estimate occupancy but compiling the current tokens and the previous tokens
# that carry forward - i think (i think) the observations at 15:00 hours are the people who start
# the day parking - not every place has the same metered hours

transaction_panel <- study.panel %>%
  replace(is.na(.), 0) %>%
  arrange(start_interval) %>%
  group_by(post_id, doty) %>%
  mutate(lag01 = ifelse(is.na(lag(tokens_01)) == FALSE, lag(tokens_01), 0),
         lag02 = ifelse(is.na(lag(tokens_02)) == FALSE, lag(tokens_02), 0),
         # lag03 = ifelse(is.na(lag(tokens_03)) == FALSE, lag(tokens_03), 0),
         # lag04 = ifelse(is.na(lag(tokens_04)) == FALSE, lag(tokens_04), 0),
         # lag05 = ifelse(is.na(lag(tokens_05)) == FALSE, lag(tokens_05), 0),
         # lag06 = ifelse(is.na(lag(tokens_06)) == FALSE, lag(tokens_06), 0),
         # lag07 = ifelse(is.na(lag(tokens_07)) == FALSE, lag(tokens_07), 0),
         # lag08 = ifelse(is.na(lag(tokens_08)) == FALSE, lag(tokens_08), 0),
         # lag09 = ifelse(is.na(lag(tokens_08)) == FALSE, lag(tokens_09), 0),
         # lag10 = ifelse(is.na(lag(tokens_10)) == FALSE, lag(tokens_10), 0),
         # lag11 = ifelse(is.na(lag(tokens_11)) == FALSE, lag(tokens_11), 0)
         ) %>%
  mutate(occupancy = tokens_00 + lag01 + lag02) %>%
  filter(is.na(occupancy) == FALSE) %>%
  dplyr::select(start_interval, post_id, occupancy)

```

### Independent Variables

#### Weather Panel

Percipitation would not be a helpful independent variable since San Francisco is quite dry during the investigated period.

```{r weather_panel, fig.width=6, fig.height=6, warning=FALSE, message=FALSE}
weather.panel <- 
  riem_measures(station = "SFO", date_start = "2022-01-03", date_end = "2022-01-23") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(start_interval = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(start_interval),
           dotw = wday(start_interval, label=TRUE)) %>%
    group_by(start_interval) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

grid.arrange(top = "Weather Data - San Francisco SFO - April, 2022",
  ggplot(weather.panel, aes(start_interval, Precipitation)) + geom_line(color=plasma(8)[2]) + 
    labs(title="Percipitation", x="Hour", y="Precipitation") + plotTheme(),
  ggplot(weather.panel, aes(start_interval, Wind_Speed)) + geom_line(color=plasma(8)[2]) + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme(),
  ggplot(weather.panel, aes(start_interval, Temperature)) + geom_line(color=plasma(8)[2]) + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme())
```

#### Amenities and Spatial Features

```{r spatial_features, warning=FALSE, message=FALSE}
# time sensitive
## sidewalk cleaning -- join to street segment
cleaning <- read.csv("data/Street_and_Sidewalk_Cleaning Count updated.csv")

# time insensitive
## pedestrian safety zone -- join to street segment, keep units
ped.safety.zone <- st_read("data/Painted Safety Zones updated.geojson") %>%
  st_transform(epsg) %>%
  st_join(., district) %>%
  filter(!is.na(district))

## park -- nn_function
park <-st_read("data/Park Lands - Recreation and Parks Department updated.geojson") %>%
  st_transform(epsg)

## on street carshare parking -- nn_function
carshare.parking <- st_read("data/On-street_Carshare_Parking updated.geojson") %>%
  st_transform(epsg)

## poi -- nn_function
poi <- st_read("data/Registered Business Locations - San Francisco updated.geojson") %>%
  st_transform(epsg)

## sidewalk width -- join to street segment, keep sidewalk_f
sidewalk.width <- read.csv("data/MTA.sidewalk_widths updated.csv")

street$park.nn <- nn_function(st_coordinates(st_centroid(street)), st_coordinates(st_centroid(park)), k = 3)
street$carshare.parking.nn <- nn_function(st_coordinates(st_centroid(street)), st_coordinates(carshare.parking), k = 3)
street$poi.nn <- nn_function(st_coordinates(st_centroid(street)), st_coordinates(poi), k = 3)

spatial_features <- street %>%
  st_drop_geometry() %>%
  dplyr::select(ST_ID, st_type, speedlimit, park.nn, carshare.parking.nn, poi.nn) %>% 
  left_join(ped.safety.zone %>% st_drop_geometry() %>% dplyr::select(ST_ID, units), by="ST_ID") %>%
  left_join(sidewalk.width, by="ST_ID")

spatial_features$units <- as.numeric(spatial_features$units)
spatial_features$speedlimit <- as.numeric(spatial_features$speedlimit)

spatial_features$st_type <- spatial_features$st_type %>% replace_na("unknown")
spatial_features$units <- spatial_features$units %>% replace_na(0)
```

```{r visualize_nn_features, warning=FALSE, message=FALSE}
spatial_features %>%
  pivot_longer(cols=ends_with(".nn"), names_to="name1", values_to="value_raw")%>%
  mutate(value_logged = log(value_raw))%>%
  pivot_longer(cols=starts_with("value"), names_to="if_log", values_to="name_log")%>%
  mutate(across(if_log, factor, levels=c("value_raw","value_logged"))) %>%
  ggplot() +
    geom_histogram(aes(name_log,fill=name1), bins=50)+
    scale_fill_manual(values=inferno(18)[5:11], guide=F)+
    facet_wrap(if_log~name1,scales = "free", nrow=2)+
    plotTheme()+
    labs(title='Distribution of Nearest Neighbor Variables',
         subtitle = 'San Francisco, 2021.9', x="")
```

```{r visualize_sidewalk_width, warning=FALSE, message=FALSE, include=FALSE}
spatial_features.sf <- merge(street %>% dplyr::select(ST_ID), spatial_features, by="ST_ID")

ggplot(spatial_features.sf) + 
  geom_sf(aes(fill = speedlimit)) +
  # scale_fill_viridis() +
  # geom_sf(data = street) +
  # geom_sf(data = meter%>%st_join(., district) %>% filter(!is.na(district)), colour="blue", size = 0.1, show.legend = "point") +
  labs(title= "Sidewalk Widths") +
  mapTheme(title_size = 14)
```

```{r construct_complete_panel, warning=FALSE, message=FALSE}
# join everything
transaction_panel <- left_join(transaction_panel, transaction %>% dplyr::select(post_id, street_block) %>% unique()) %>%
  mutate(POST_ID = post_id) %>% 
  dplyr::select(-post_id) %>%
  merge(idx, by="POST_ID")

# 
# transaction_panel <- transaction_panel %>%
#   group_by(ST_ID", "doty", "start_interval15") %>%
#   summarize(total_occupancy = sum(occupancy))
# 
#   # merge(transaction_panel %>% mutate(POST_ID = post_id) %>% dplyr::select(-post_id), by="POST_ID")

panel <- spatial_features %>%
  merge(transaction_panel %>%
          group_by(ST_ID, doty, start_interval) %>%
          summarize(total_occupancy = sum(occupancy)), by="ST_ID")

panel <- panel %>%
  arrange(ST_ID, start_interval) %>% 
  mutate(lagHour = dplyr::lag(total_occupancy, 1),
         lag2Hours = dplyr::lag(total_occupancy, 2),
         lag3Hours = dplyr::lag(total_occupancy, 3),
         lag12Hours = dplyr::lag(total_occupancy, 12),
         lag1day = dplyr::lag(total_occupancy, 24),
         week = week(start_interval),
         wday = wday(start_interval, label=TRUE)) %>%
  ungroup() %>%
  merge(weather.panel, by="start_interval")

```

```{r plot_lag_correlation, warning=FALSE, message=FALSE}
plotData.lag <-
  as.data.frame(panel)%>%
  dplyr::select(starts_with("lag"), total_occupancy) %>%
  gather(Variable, Value, -total_occupancy) %>%
  mutate(Variable = fct_relevel(Variable, "lagHour","lag2Hours","lag3Hours",
                                "lag4Hours","lag12Hours","lag1day"))
correlation.lag <-
  group_by(plotData.lag, Variable) %>%
  summarize(correlation = round(cor(Value, total_occupancy, use = "complete.obs"), 2))

plotData.lag %>% sample_n(100000)%>%
ggplot(aes(Value, total_occupancy)) +
  geom_point(size = 0.1) +
  geom_text(data = correlation.lag, 
            aes(label = paste("r =", round(correlation, 2))),
            x=-Inf, y=Inf, vjust = 1.5, hjust = -.1,size=5) +
  geom_smooth(method = "lm", se = FALSE, color = plasma(8)[2]) +
  facet_wrap(~Variable, nrow = 2, scales = "free") +
  labs(title = "") +
  plotTheme()
```

```{r}
ggplot(panel) +
  geom_histogram(aes(x = total_occupancy), color="white", fill = plasma(8)[1]) +
  labs(title = "Occupancy Distribution", x = "Occupancy Count", y = "Count", subtitle = "San Francisco Downtown") +
  plotTheme()
```
```{r temporal_pattern}
# transaction_panel %>%
#   filter(interval60>= "2021-09-01 00:00:00" & interval60 <= "2021-09-30 23:59:59")%>%
#   group_by(interval60, status)%>%
#   summarise(parking_time_in_60m = sum(parking_time_in_60m))%>%
#   ggplot(aes(ymd_hms(interval60),parking_time_in_60m, colour = status))+
#     geom_line()+
#   geom_vline(data = sundays, aes(xintercept = sunday))+
#   scale_colour_manual(values = p2)+
#   labs(title="Total Parking Time by week in SF: September 2021",
#        x="Day", y="Total Parking Time (Second)") +
#   plotTheme() + theme(panel.grid.major = element_blank())

int.ampeak <- interval(as_hms("07:00:00"),as_hms("10:00:00"))
int.pmpeak <- interval(as_hms("15:00:00"),as_hms("18:00:00"))
int.midday <- interval(as_hms("10:00:00"),as_hms("15:00:00"))
int.night <- interval(as_hms("18:00:00"),as_hms("23:00:00"))
int.overnight <- interval(as_hms("00:00:00"),as_hms("07:00:00"))

panel.temporal <- panel %>%
  mutate(period = case_when(ymd_hms(paste0('1970-01-01',str_sub(start_interval, 12)))%within% int.ampeak ~ "AM",
                            ymd_hms(paste0('1970-01-01',str_sub(start_interval, 12)))%within% int.pmpeak ~ "PM",
                            ymd_hms(paste0('1970-01-01',str_sub(start_interval, 12)))%within% int.midday ~ "Mid_Day",
                            ymd_hms(paste0('1970-01-01',str_sub(start_interval, 12)))%within% int.night ~ "Night",
                            ymd_hms(paste0('1970-01-01',str_sub(start_interval, 12)))%within% int.overnight ~ "Overnight"))


panel.temporal %>%
  mutate(across(period, factor, levels=c("Overnight","AM","Mid_Day","PM","Night"))) %>%
  group_by(start_interval, ST_ID, period) %>%
  summarize(mean_occupancy = mean(total_occupancy))%>%
  ggplot()+
  geom_histogram(aes(mean_occupancy), color="white", fill=plasma(8)[5])+
  labs(title="Mean Occupancy Per Street Segment",
       subtitle="San Francisco, 2022.1",
       x="Mean Occupancy", 
       y="Frequency")+
  facet_wrap(~period)+
  plotTheme()
```
```{r animation}
panel.sf <- merge(street%>%dplyr::select(ST_ID), panel, by="ST_ID") %>%
  filter(doty == 3) %>% 
  mutate(hour = hour(start_interval)) %>%
  dplyr::select(ST_ID, hour, total_occupancy) %>%
  st_sf() %>%
  rename(time_hour = hour)

map.lables <- qBr(panel.sf, "total_occupancy")

animation =
  ggplot()+
    #geom_sf(data = sf_neighborhood, fill="#cccccc", color="#999999")+
    geom_sf(data= panel.sf, 
            aes(color=total_occupancy, size=total_occupancy, alpha=total_occupancy),
            stroke = .5, shape = 16)+
    viridis::scale_color_viridis(option = "C")+
    scale_size_continuous(range = c(0.5,4))+
    scale_alpha_continuous(range = c(0.5,1))+
    transition_manual(time_hour) +
    labs(title="Occupancy per Street Segments by Hour",
         subtitle = "Time: {current_frame}:00, San Francisco, 2022.1")+
    mapTheme()

# animate(animation, duration=20, renderer = gifski_renderer())
anim_save("ani.gif", height = 800, width =800, animation, duration=4, renderer = gifski_renderer())

animate(animation, duration=10, renderer = gifski_renderer())
```


```{r model, warning=FALSE, message=FALSE}
panel.train <- panel %>% filter(week < 4)
panel.test <- panel %>% filter(week == 4)

# reg <- glm(total_occupancy ~  st_type + hour(start_interval) + speedlimit + park.nn + carshare.parking.nn + poi.nn + units + sidewalk_f +lagHour,  data=panel, family = poisson())

reg1 <- lm(total_occupancy ~  Temperature + Precipitation + Wind_Speed,  data=panel.train)

reg2 <- lm(total_occupancy ~  st_type + speedlimit + park.nn + carshare.parking.nn + poi.nn + units + sidewalk_f + Temperature + Precipitation + Wind_Speed,  data=panel.train)

reg3 <- lm(total_occupancy ~  st_type + hour(start_interval) + speedlimit + park.nn + carshare.parking.nn + poi.nn + units + sidewalk_f + Temperature + Precipitation + Wind_Speed + wday,  data=panel.train)

reg4 <- lm(total_occupancy ~  st_type + hour(start_interval) + speedlimit + park.nn + carshare.parking.nn + poi.nn + units + sidewalk_f +lagHour + lag2Hours + lag3Hours + lag12Hours + lag1day + wday + Temperature + Precipitation + Wind_Speed,  data=panel.train)
```


```{r model_comparison, warning=FALSE, message=FALSE}
model_pred <- function(dat, fit){
   pred <- predict(fit, newdata = dat)}

panel.test.weekNest <- 
  panel.test %>%
  nest(-week) 

week_predictions <- 
  panel.test.weekNest %>% 
    mutate(Weather_model = map(.x = data, fit = reg1, .f = model_pred),
           Weather_Space_model = map(.x = data, fit = reg2, .f = model_pred),
           Weather_Space_Time_model = map(.x = data, fit = reg3, .f = model_pred),
           Weather_Space_Time_Lag_model = map(.x = data, fit = reg4, .f = model_pred))

mean.na = function(x) {mean(x,na.rm=T)}
sd.na = function(x) {sd(x,na.rm=T)}
week_predictions

week_predictions <- week_predictions %>%  
    gather(Regression, Prediction, -data, -week) %>% 
    mutate(Observed = map(data, pull, total_occupancy),
           Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
           MAE = map_dbl(Absolute_Error, mean.na),
           sd_AE = map_dbl(Absolute_Error, sd.na))

week_predictions %>%
  dplyr::select(week, Regression, MAE) %>%
  gather(Variable, MAE, -Regression, -week) %>%
  mutate(
    across(Regression,factor,levels=c("Weather_model","Weather_Space_model","Weather_Space_Time_model",
                                    "Weather_Space_Time_Lag_model"))
  )%>%
  ggplot(aes(week%>%as.factor(), MAE)) + 
    geom_bar(aes(fill = Regression), position = "dodge", stat="identity") +
    scale_fill_manual(values = plasma(8)[2:6]) +
    labs(title = "Mean Absolute Errors by model specification and week",x="week") +
  plotTheme()

```

```{r, include=FALSE}
# week_predictions %>% 
#   mutate(start_interval = map(data, pull, start_interval)) %>%
#   dplyr::select(start_interval, Observed, Prediction, Regression) %>%
#   unnest() %>%
#   gather(Variable, Value, -Regression, -start_interval) %>%
#   group_by(Regression, Variable, start_interval) %>%
#   summarize(Value = mean(Value,na.rm=T)) %>%
#   ungroup%>%
#   mutate(
#     across(Regression,factor,levels=c("Weather_model","Weather_Space_model","Weather_Space_Time_model",
#                                     "Weather_Space_Time_Lag_model"))
#   )%>%
#   filter(Regression!="Poisson_model") %>% 
#   ggplot(aes(start_interval, Value, colour=Variable)) + 
#   geom_line(size = .8) + 
#   facet_wrap(~Regression, ncol=1) +
#   labs(title = "Mean Predicted/Observed Parking Time by hourly interval", 
#        x = "Date", y= "Parking Time") +
#   plotTheme()
```

```{r cross_validation, warning=FALSE, message=FALSE}
fitControl <- trainControl(method = "cv", number = 100)
set.seed(26)
reg.cv = train(total_occupancy ~  st_type + hour(start_interval) + speedlimit + park.nn + carshare.parking.nn + poi.nn + units + sidewalk_f +lagHour + lag2Hours + lag3Hours + lag12Hours + lag1day + wday + Temperature + Precipitation + Wind_Speed,  data=panel.train,
     method = "lm", trControl = fitControl, na.action = na.pass)


MAE4 <- reg.cv$resample
ggplot(MAE4, aes(x=MAE)) + 
  geom_histogram(color="white", fill = plasma(8)[6]) +
  labs(title = "Histogram of MAE of Cross Validation", subtitle = "Model: Weather_Space_Time_Lag",  x = "MAE", y= "Count") +
  plotTheme()
```

